<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>UVAW Test Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
html,body,#map { height:100%; margin:0; padding:0; }
#map { width:100%; }
.popup-title { font-weight:700; margin-bottom:6px; font-size:1.05em; }
.popup-field { margin-bottom:6px; }
.popup-label { font-weight:700; margin-right:6px; }
.popup-link { color:#007bff; text-decoration:underline; }
</style>

<!-- Leaflet JS (must load before plugin and your map code) -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Google Maps JS: REPLACE the placeholder with your API key (no quotes) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLvshjOq7PXpUhp-266OI1KvM71BwhCsI"></script>

<!-- google-mutant plugin (must come AFTER the Google Maps script and Leaflet) -->
<script src="https://unpkg.com/leaflet.gridlayer.googlemutant/Leaflet.GoogleMutant.js"></script>

<!-- PapaParse (CSV parser) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div id="map"></div>

<script>
// ========== CONFIG ==========
// Published CSV URL (replace if you have a different sheet)
const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6sULFXZr4vz2DLbg7AreeHc9GGjZuAr-AFYxLgGFTtQGDpX0cWBXj5lVahiGYXHi5s1gGzMs0WgPt/pub?output=csv';

// Icon mapping (Drive UC links). Ensure these files/folder are shared "Anyone with the link (Viewer)"
const iconBaseMap = {
'1': 'https://drive.google.com/uc?export=view&id=1_GlFtDpGGKdx7dV-Kg-uTtUB0E7OrucF',
'2': 'https://drive.google.com/uc?export=view&id=1G5K4M6TUBYF5Ivg5i0eBipXof3V9t9b9',
'3': 'https://drive.google.com/uc?export=view&id=1qfxAo4Qsh4yol7_iJLZ_PD7V7pbv1etA',
'4': 'https://drive.google.com/uc?export=view&id=1J4aMcxb4o99Bs_mCfmc9wwW0MEgzejER',
'5': 'https://drive.google.com/uc?export=view&id=176wy1qZZrhxYh0w44lgPlO1h9qW9kPhg',
'6': 'https://drive.google.com/uc?export=view&id=1_OCP8wEshvqr9XZIW5eDvxBC763b0g0m',
'7': 'https://drive.google.com/uc?export=view&id=1hH4pjt63GfChholToFvvRfH3fpGEEntH',
'8': 'https://drive.google.com/uc?export=view&id=1LL7hhU9b2E3MUgpRAgKvnu7RVecZjGPY',
'icon_01.png': 'https://drive.google.com/uc?export=view&id=1_GlFtDpGGKdx7dV-Kg-uTtUB0E7OrucF',
'icon_02.png': 'https://drive.google.com/uc?export=view&id=1G5K4M6TUBYF5Ivg5i0eBipXof3V9t9b9',
'icon_03.png': 'https://drive.google.com/uc?export=view&id=1qfxAo4Qsh4yol7_iJLZ_PD7V7pbv1etA',
'icon_04.png': 'https://drive.google.com/uc?export=view&id=1J4aMcxb4o99Bs_mCfmc9wwW0MEgzejER',
'icon_05.png': 'https://drive.google.com/uc?export=view&id=176wy1qZZrhxYh0w44lgPlO1h9qW9kPhg',
'icon_06.png': 'https://drive.google.com/uc?export=view&id=1_OCP8wEshvqr9XZIW5eDvxBC763b0g0m',
'icon_07.png': 'https://drive.google.com/uc?export=view&id=1hH4pjt63GfChholToFvvRfH3fpGEEntH',
'icon_08.png': 'https://drive.google.com/uc?export=view&id=1LL7hhU9b2E3MUgpRAgKvnu7RVecZjGPY'
};
// ============================

// Initialize map and base layers
const map = L.map('map').setView([43.7, -72.3], 11);

// OpenStreetMap tile (optional layer)
const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19,
attribution: '&copy; OpenStreetMap contributors'
});

// Google base layers via google-mutant
const googleRoad = L.gridLayer.googleMutant({ type: 'roadmap' }); // default Google map
const googleSatellite = L.gridLayer.googleMutant({ type: 'satellite' });
const googleHybrid = L.gridLayer.googleMutant({ type: 'hybrid' });

// Default base (Google roadmap). Change to osmLayer.addTo(map) if you prefer OSM by default.
googleRoad.addTo(map);

// Layer switcher
L.control.layers({
"OpenStreetMap": osmLayer,
"Google Roadmap": googleRoad,
"Google Satellite": googleSatellite,
"Google Hybrid": googleHybrid
}).addTo(map);

// Icon utilities
const defaultIcon = new L.Icon.Default();
const iconCache = {};

function esc(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function tryLoadImg(url, timeout=6000) {
return new Promise(resolve => {
try {
const img = new Image();
let done=false;
const t = setTimeout(()=>{ if(done) return; done=true; img.onload=img.onerror=null; resolve(false); }, timeout);
img.onload = ()=>{ if(done) return; done=true; clearTimeout(t); resolve(true); };
img.onerror = ()=>{ if(done) return; done=true; clearTimeout(t); resolve(false); };
img.src = url;
} catch(e) { resolve(false); }
});
}

async function getGoodIconUrl(origUrl) {
if (!origUrl) return null;
const candidates = [origUrl];
const m = origUrl.match(/\/d\/([a-zA-Z0-9_-]{10,})|[?&]id=([a-zA-Z0-9_-]{10,})/);
const id = m ? (m[1]||m[2]) : null;
if (id) {
candidates.push('https://drive.google.com/uc?export=download&id=' + id);
candidates.push('https://drive.googleusercontent.com/uc?export=view&id=' + id);
candidates.push('https://drive.google.com/thumbnail?id=' + id);
}
const tried = new Set();
for (const u of candidates) {
if (!u || tried.has(u)) continue;
tried.add(u);
const ok = await tryLoadImg(u);
if (ok) return u;
}
return null;
}

async function prepareIcons() {
const keys = Object.keys(iconBaseMap);
for (const key of keys) {
const url = iconBaseMap[key];
if (!url) continue;
try {
const good = await getGoodIconUrl(url);
if (good) iconCache[key] = L.icon({ iconUrl: good, iconSize:[36,36], iconAnchor:[18,36], popupAnchor:[0,-36] });
else iconCache[key] = null;
} catch (e) {
iconCache[key] = null;
}
}
}

function resolveIconFromCell(cellValue) {
if (cellValue == null) return null;
const s = String(cellValue).trim();
if (!s) return null;
if (/^https?:\/\//i.test(s)) return { type:'url', value:s };
const parts = s.split(/[,\|;\/]+/).map(p=>p.trim()).filter(Boolean);
for (const p of parts) {
if (iconCache[p]) return { type:'key', value:p };
if (/^\d+$/.test(p) && iconCache[p]) return { type:'key', value:p };
const fname = 'icon_' + String(p).padStart(2,'0') + '.png';
if (iconCache[fname]) return { type:'key', value:fname };
}
return null;
}

function findFieldName(fields, candidates) {
if (!fields) return null;
const normalized = fields.map(f => (f||'').toString().trim().toLowerCase().replace(/\s+/g,' '));
for (const cand of candidates) {
const c = (cand||'').toString().trim().toLowerCase().replace(/\s+/g,' ');
const idx = normalized.indexOf(c);
if (idx !== -1) return fields[idx];
}
for (let i=0;i<fields.length;i++){
const f = (fields[i]||'').toString().toLowerCase();
for (const cand of candidates) {
if (cand && f.indexOf(cand.toString().toLowerCase()) !== -1) return fields[i];
}
}
return null;
}

// Main: prepare icons, parse CSV and add markers
(async function main() {
await prepareIcons();

Papa.parse(sheetURL, {
download: true,
header: true,
skipEmptyLines: true,
complete: function(results) {
const rows = results.data || [];
const fields = (results.meta && results.meta.fields) ? results.meta.fields : [];

// auto-detect common headers
const websiteField = findFieldName(fields, ['Website','site','url']);
const addressField = findFieldName(fields, ['Google Map Location','Address','Location']);
const orgField = findFieldName(fields, ['Organization Name','Organization','Name']);
const resilienceField = findFieldName(fields, ['Resilience','resilience']);
const latField = findFieldName(fields, ['lat','latitude']);
const lonField = findFieldName(fields, ['lon','lng','longitude']);

if (!latField || !lonField) {
alert('Latitude/Longitude columns not found. Detected headers: ' + JSON.stringify(fields));
return;
}

const markers = [];
rows.forEach(row => {
const lat = parseFloat(String(row[latField] || '').replace(/,/g,'').trim());
const lon = parseFloat(String(row[lonField] || '').replace(/,/g,'').trim());
if (isNaN(lat) || isNaN(lon)) return;

// resolve icon
let iconOption = defaultIcon;
const iconResolved = resolveIconFromCell(row[resilienceField] || '');
if (iconResolved) {
if (iconResolved.type === 'key') {
const ic = iconCache[iconResolved.value];
if (ic) iconOption = ic;
} else if (iconResolved.type === 'url') {
iconOption = L.icon({ iconUrl: iconResolved.value, iconSize:[36,36], iconAnchor:[18,36], popupAnchor:[0,-36] });
}
}

// build popup (clickable website and address to Google Maps)
const parts = [];
const orgVal = orgField ? row[orgField] : (row['Organization Name'] || '');
if (orgVal) parts.push('<div class="popup-title">' + esc(orgVal) + '</div>');

const websiteRaw = websiteField ? String(row[websiteField] || '').trim() : '';
if (websiteRaw) {
const href = (/^https?:\/\//i.test(websiteRaw)) ? websiteRaw : ('http://' + websiteRaw);
parts.push('<div class="popup-field"><span class="popup-label">Website:</span><a class="popup-link" href="' + esc(href) + '" target="_blank" rel="noopener noreferrer">' + esc(websiteRaw) + '</a></div>');
}

const addrVal = addressField ? String(row[addressField] || '').trim() : '';
if (addrVal) {
const mapsLink = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(addrVal);
parts.push('<div class="popup-field"><span class="popup-label">Address:</span><a class="popup-link" href="' + esc(mapsLink) + '" target="_blank" rel="noopener noreferrer">' + esc(addrVal) + '</a></div>');
}

const townsField = findFieldName(fields, ['Towns Serviced','Towns','towns serviced']);
const townsVal = townsField ? String(row[townsField] || '').trim() : '';
if (townsVal) parts.push('<div class="popup-field"><span class="popup-label">Towns Serviced:</span>' + esc(townsVal) + '</div>');

const emailField = findFieldName(fields, ['Email','E-mail','email']);
const emailVal = emailField ? String(row[emailField] || '').trim() : '';
if (emailVal) parts.push('<div class="popup-field"><span class="popup-label">Email:</span><a class="popup-link" href="mailto:' + esc(emailVal) + '">' + esc(emailVal) + '</a></div>');

const phoneField = findFieldName(fields, ['Phone','phone','Telephone','telephone']);
const phoneVal = phoneField ? String(row[phoneField] || '').trim() : '';
if (phoneVal) parts.push('<div class="popup-field"><span class="popup-label">Phone Number:</span><a class="popup-link" href="tel:' + esc(phoneVal) + '">' + esc(phoneVal) + '</a></div>');

const zoneField = findFieldName(fields, ['Geographic Zone','Zone','geographic zone']);
const zoneVal = zoneField ? String(row[zoneField] || '').trim() : '';
if (zoneVal) parts.push('<div class="popup-field"><span class="popup-label">Zone:</span>' + esc(zoneVal) + '</div>');

const missionField = findFieldName(fields, ['Mission','mission']);
const missionVal = missionField ? String(row[missionField] || '').trim() : '';
if (missionVal) parts.push('<div class="popup-field" style="margin-top:8px;">' + esc(missionVal) + '</div>');

const popupHtml = parts.join('');
const marker = L.marker([lat, lon], { icon: iconOption }).addTo(map);
marker.bindPopup(popupHtml);
markers.push(marker);
});

if (markers.length) {
const fg = L.featureGroup(markers);
map.fitBounds(fg.getBounds().pad(0.1));
} else {
const ctr = map.getCenter();
L.marker(ctr).addTo(map).bindPopup('No markers found').openPopup();
}
},
error: function(err) {
console.error('CSV load error', err);
alert('CSV load error - check console');
}
});
})();
</script>
</body>
</html>








